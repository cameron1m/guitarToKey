#!/usr/bin/env node
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const commander_1 = __importDefault(require("commander"));
const request_1 = require("../request");
const pipeline_1 = require("../pipeline");
const router_1 = require("../router");
const utils_1 = require("../utils");
const PipelineStatus = ['creating', 'running', 'success', 'fail'];
function list() {
    return __awaiter(this, void 0, void 0, function* () {
        const jobs = yield request_1.get(`${router_1.route.job}/list`);
        console.table(jobs.rows.map((item) => {
            item.status = PipelineStatus[item.status];
            return item;
        }), ['id', 'status', 'evaluatePass', 'createdAt']);
    });
}
function remove() {
    return __awaiter(this, void 0, void 0, function* () {
        utils_1.logger.start('removing jobs...');
        yield request_1.get(`${router_1.route.job}/remove`);
        utils_1.logger.success('remove jobs succeeded');
    });
}
function stop(id) {
    return __awaiter(this, void 0, void 0, function* () {
        utils_1.logger.start('stopping jobs...');
        const err = yield request_1.get(`${router_1.route.job}/stop`, { id });
        err ? utils_1.logger.fail(err.message) : utils_1.logger.success('stop job succeeded');
    });
}
function log(id) {
    return __awaiter(this, void 0, void 0, function* () {
        const log = yield request_1.get(`${router_1.route.job}/${id}/log`);
        console.log(log);
    });
}
commander_1.default
    .command('list')
    .action(list)
    .description('list all jobs');
commander_1.default
    .command('run <pipeline>')
    .option('--verbose', 'prints verbose logs', true)
    .option('--tuna', 'use tuna mirror to install python packages')
    .option('--output', 'the output directory name', 'output')
    .action(pipeline_1.run)
    .description('run a job from a pipeline id');
commander_1.default
    .command('remove')
    .action(remove)
    .description('remove all the jobs');
commander_1.default
    .command('log <job>')
    .action(log)
    .description('show logs by the given job id');
commander_1.default
    .command('stop <job>')
    .action(stop)
    .description('stop job by the given job id');
commander_1.default.parse(process.argv);
//# sourceMappingURL=pipcook-job.js.map